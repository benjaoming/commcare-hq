on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, closed]

name: Update transifex translations
jobs:
  update_translations:
    name: Update transifex translations
    runs-on: ubuntu-latest
    steps:
      - name: Install transifex client
        run: |
          mkdir -p /home/runner/.local/bin
          cd /home/runner/.local/bin
          curl -o- https://raw.githubusercontent.com/transifex/cli/master/install.sh | bash
      - name: Run update-translations script
        # From https://github.com/marketplace/actions/create-pr-action:
        # > executes an arbitrary command and commits the changes to the new pull request
        uses: technote-space/create-pr-action@v2
        env:
          TRANSIFEX_TOKEN: ${{ secrets.TRANSIFEX_TOKEN }}
        with:
          EXECUTE_COMMANDS: |
            pip install --upgrade pip
            pip install -r requirements/requirements.txt
            # copy .transifexrc.example to ~/.transifexrc, edited to include token
            grep -v '^token =' .transifexrc.example > ~/.transifexrc
            echo "token = ${TRANSIFEX_TOKEN}" >> ~/.transifexrc
            ./scripts/update-translations.sh
          COMMIT_MESSAGE: |
            Update translations.

            [ci skip]
          PR_BRANCH_NAME: 'update-translations'
          PR_TITLE: 'Update Translations'
